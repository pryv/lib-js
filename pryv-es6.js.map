{"version":3,"file":"pryv-es6.js","mappings":"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","sources":["webpack://lib-js/./components/pryv/src/Browser/CookieUtils.js","webpack://lib-js/./components/pryv/src/browser-index.js","webpack://lib-js/./components/pryv/src/Auth/AuthController.js","webpack://lib-js/./components/pryv/src/ServiceAssets.js","webpack://lib-js/./components/pryv/src/Service.js","webpack://lib-js/./components/pryv/src/Auth/LoginMessages.js","webpack://lib-js/./components/pryv/src/lib/json-parser.js","webpack://lib-js/./components/pryv/src/Browser/index.js","webpack://lib-js/./components/pryv/src/utils.js","webpack://lib-js/./components/pryv/src/Auth/AuthStates.js","webpack://lib-js/./components/pryv/src/Auth/index.js","webpack://lib-js/./components/pryv/src/Connection.js","webpack://lib-js/./components/pryv/src/lib/getEventStreamed.js","webpack://lib-js/./components/pryv/src/Browser/LoginButton.js","webpack://lib-js/./components/pryv/src/lib/PryvError.js","webpack://lib-js/./components/pryv/src/index.js","webpack://lib-js/webpack/bootstrap","webpack://lib-js/webpack/runtime/global","webpack://lib-js/webpack/startup"],"sourcesContent":["/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n\nconst utils = require('../utils');\n\n/**\n * @memberof pryv.Browser\n * @namespace pryv.Browser.CookieUtils\n */\nmodule.exports = {\n  get,\n  set,\n  del\n};\n\n/**\n  * Set a local cookie\n  * @memberof pryv.Browser.CookieUtils\n  * @template T\n  * @param {string} cookieKey - The key for the cookie\n  * @param {T} value - The value (will be JSON stringified)\n  * @param {number} [expireInDays=365] - Expiration date in days from now\n  */\nfunction set (cookieKey, value, expireInDays) {\n  if (!utils.isBrowser()) return;\n  expireInDays = expireInDays || 365;\n  const myDate = new Date();\n  const hostName = window.location.hostname;\n  const path = window.location.pathname;\n  myDate.setDate(myDate.getDate() + expireInDays);\n  let cookieStr = encodeURIComponent(cookieKey) + '=' +\n    encodeURIComponent(JSON.stringify(value)) +\n    ';expires=' + myDate.toUTCString() +\n    ';domain=.' + hostName + ';path=' + path;\n  // do not add SameSite when removing a cookie\n  if (expireInDays >= 0) cookieStr += ';SameSite=Strict';\n  document.cookie = cookieStr;\n}\n\n/**\n * Return the value of a local cookie\n * @memberof pryv.Browser.CookieUtils\n * @template T\n * @param {string} cookieKey - The key\n * @returns {T|undefined} The parsed cookie value or undefined if not found\n */\nfunction get (cookieKey) {\n  const name = encodeURIComponent(cookieKey);\n  if (!utils.isBrowser()) return;\n  const value = '; ' + document.cookie;\n  const parts = value.split('; ' + name + '=');\n  if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));\n}\n\n/**\n * Delete a local cookie\n * @memberof pryv.Browser.CookieUtils\n * @param {string} cookieKey - The key\n */\nfunction del (cookieKey) {\n  set(cookieKey, { deleted: true }, -1);\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n// make lib available as `Pryv` (with capital P, deprecated) for backward-compatibility with apps importing via <script>\n// TODO: remove deprecated alias with next major version\nmodule.exports = global.Pryv = require('./index');\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst utils = require('../utils');\nconst AuthStates = require('./AuthStates');\nconst Messages = require('./LoginMessages');\n\n/**\n * Controller for authentication flow\n * @memberof pryv.Auth\n */\nclass AuthController {\n  /**\n   * Create an AuthController\n   * @param {AuthSettings} settings - Authentication settings\n   * @param {Service} service - Pryv service instance\n   * @param {CustomLoginButton} loginButton - Login button implementation\n   */\n  constructor (settings, service, loginButton) {\n    this.settings = settings;\n    validateSettings.call(this, settings);\n\n    this.stateChangeListeners = [];\n    if (this.settings.onStateChange) {\n      this.stateChangeListeners.push(this.settings.onStateChange);\n    }\n    this.service = service;\n\n    // probably remove\n    this.languageCode = this.settings.authRequest.languageCode || 'en';\n    this.messages = Messages(this.languageCode);\n\n    this.loginButton = loginButton;\n\n    function validateSettings (settings) {\n      if (!settings) { throw new Error('settings cannot be null'); }\n      // -- settings\n      if (!settings.authRequest) { throw new Error('Missing settings.authRequest'); }\n\n      // -- Extract returnURL\n      settings.authRequest.returnURL =\n        this.getReturnURL(settings.authRequest.returnURL);\n\n      if (!settings.authRequest.requestingAppId) {\n        throw new Error('Missing settings.authRequest.requestingAppId');\n      }\n      if (!settings.authRequest.requestedPermissions) {\n        throw new Error('Missing settings.authRequest.requestedPermissions');\n      }\n    }\n  }\n\n  /**\n   * Initialize the auth controller. Call this right after instantiation.\n   * @returns {Promise<Service>} Promise resolving to the Service instance\n   */\n  async init () {\n    this.serviceInfo = this.service.infoSync();\n    this.state = { status: AuthStates.LOADING };\n    this.assets = await loadAssets(this);\n\n    const loginButton = this.loginButton;\n    // initialize human interaction interface\n    if (loginButton != null) {\n      this.stateChangeListeners.push(loginButton.onStateChange.bind(loginButton));\n      // autologin needs cookies/storage implemented in human interaction interface\n      await checkAutoLogin(this);\n    }\n\n    // if auto login is not prompted\n    if (this.state.status !== AuthStates.AUTHORIZED) {\n      this.state = { status: AuthStates.INITIALIZED, serviceInfo: this.serviceInfo };\n    }\n\n    if (loginButton != null && loginButton.finishAuthProcessAfterRedirection != null) {\n      // @ts-ignore - this is a valid AuthController\n      await loginButton.finishAuthProcessAfterRedirection(this);\n    }\n\n    return this.service;\n  }\n\n  /**\n   * Stops poll for auth request\n   */\n  stopAuthRequest (msg) {\n    this.state = { status: AuthStates.ERROR, message: msg };\n  }\n\n  /**\n   * Handle button click - triggers appropriate action based on current state\n   * @returns {Promise<void>}\n   */\n  async handleClick () {\n    if (isAuthorized.call(this)) {\n      this.state = { status: AuthStates.SIGNOUT };\n    } else if (isInitialized.call(this)) {\n      this.startAuthRequest();\n    } else if (isNeedSignIn.call(this)) {\n      // reopen popup (HACK for now: set to private property to avoid self-assignment)\n      this.state = this._state;\n    } else {\n      console.log('Unhandled action in \"handleClick()\" for status:', this.state.status);\n    }\n\n    function isAuthorized () {\n      return this.state.status === AuthStates.AUTHORIZED;\n    }\n    function isInitialized () {\n      return this.state.status === AuthStates.INITIALIZED;\n    }\n    function isNeedSignIn () {\n      return this.state.status === AuthStates.NEED_SIGNIN;\n    }\n  }\n\n  /**\n   * Compute the return URL for authentication redirect.\n   * Used only in browser environments.\n   * @param {string} [returnURL] - The return URL setting ('auto#', 'self#', or custom URL)\n   * @param {string} [windowLocationForTest] - Mock window.location.href for testing\n   * @param {string|Navigator} [navigatorForTests] - Mock navigator for testing\n   * @returns {string|boolean} The computed return URL, or false if using popup mode\n   */\n  getReturnURL (\n    returnURL,\n    windowLocationForTest,\n    navigatorForTests\n  ) {\n    const RETURN_URL_AUTO = 'auto';\n\n    returnURL = returnURL || RETURN_URL_AUTO + '#';\n\n    // check the trailer\n    const trailer = returnURL.slice(-1);\n    if ('#&?'.indexOf(trailer) < 0) {\n      throw new Error('Pryv access: Last character of --returnURL setting-- is not ' +\n        '\"?\", \"&\" or \"#\": ' + returnURL);\n    }\n    // auto mode for desktop\n    if (returnUrlIsAuto(returnURL) &&\n        !utils.browserIsMobileOrTablet(navigatorForTests)) {\n      return false;\n    // auto mode for mobile or self\n    } else if ((returnUrlIsAuto(returnURL) &&\n                utils.browserIsMobileOrTablet(navigatorForTests)) ||\n               returnURL.indexOf('self') === 0) {\n      // set self as return url?\n      // eventually clean-up current url from previous pryv returnURL\n      const locationHref = windowLocationForTest || window.location.href;\n      returnURL = locationHref + returnURL.substring(4);\n    }\n    return utils.cleanURLFromPrYvParams(returnURL);\n\n    function returnUrlIsAuto (returnURL) {\n      return returnURL.indexOf(RETURN_URL_AUTO) === 0;\n    }\n  }\n\n  /**\n   * Start the authentication request and polling process\n   * @returns {Promise<void>}\n   * @see https://pryv.github.io/reference/#auth-request\n   */\n  async startAuthRequest () {\n    // @ts-ignore - postAccess uses .call(this) for context\n    this.state = await postAccess.call(this);\n\n    await doPolling.call(this);\n\n    /** @this {AuthController} */\n    async function postAccess () {\n      try {\n        const { response, body } = await utils.fetchPost(\n          // @ts-ignore - this is bound via .call()\n          this.serviceInfo.access,\n          // @ts-ignore - this is bound via .call()\n          this.settings.authRequest\n        );\n        if (!response.ok) {\n          throw new Error('Access request failed: ' + JSON.stringify(body));\n        }\n        return body;\n      } catch (e) {\n        this.state = {\n          status: AuthStates.ERROR,\n          message: 'Requesting access',\n          error: e\n        };\n        throw e; // forward error\n      }\n    }\n\n    /** @this {AuthController} */\n    async function doPolling () {\n      // @ts-ignore - this is bound via .call()\n      if (this.state?.status !== AuthStates.NEED_SIGNIN) {\n        return;\n      }\n      // @ts-ignore - this is bound via .call()\n      const pollResponse = await pollAccess(this.state?.poll);\n\n      if (pollResponse.status === AuthStates.NEED_SIGNIN) {\n        // @ts-ignore - this is bound via .call()\n        setTimeout(await doPolling.bind(this), this.state?.poll_rate_ms);\n      } else {\n        this.state = pollResponse;\n      }\n\n      async function pollAccess (pollUrl) {\n        try {\n          const { response, body } = await utils.fetchGet(pollUrl);\n          if (response.status === 403 && body?.status === 'REFUSED') {\n            return { status: AuthStates.INITIALIZED };\n          }\n          return body;\n        } catch (e) {\n          return { status: AuthStates.ERROR, message: 'Error while polling for auth request', error: e };\n        }\n      }\n    }\n  }\n\n  // -------------- state listeners ---------------------\n  set state (newState) {\n    // retro-compatibility for lib-js < 2.0.9\n    newState.id = newState.status;\n\n    this._state = newState;\n\n    this.stateChangeListeners.forEach((listener) => {\n      try {\n        listener(this.state);\n      } catch (e) {\n        console.log('Error during set state ()', e);\n      }\n    });\n  }\n\n  get state () {\n    return this._state;\n  }\n}\n\n// ----------- private methods -------------\n\nasync function checkAutoLogin (authController) {\n  const loginButton = authController.loginButton;\n  if (loginButton == null) {\n    return;\n  }\n\n  const storedCredentials = await loginButton.getAuthorizationData();\n  if (storedCredentials != null) {\n    authController.state = Object.assign({}, { status: AuthStates.AUTHORIZED }, storedCredentials);\n  }\n}\n\n// ------------------ ACTIONS  ----------- //\n\nasync function loadAssets (authController) {\n  let loadedAssets = {};\n  try {\n    loadedAssets = await authController.service.assets();\n    if (typeof location !== 'undefined') {\n      await loadedAssets.loginButtonLoadCSS();\n      const thisMessages = await loadedAssets.loginButtonGetMessages();\n      if (thisMessages.LOADING) {\n        authController.messages = Messages(authController.languageCode, thisMessages);\n      } else {\n        console.log('WARNING Messages cannot be loaded using defaults: ', thisMessages);\n      }\n    }\n  } catch (e) {\n    authController.state = {\n      status: AuthStates.ERROR,\n      message: 'Cannot fetch button visuals',\n      error: e\n    };\n    throw e; // forward error\n  }\n  return loadedAssets;\n}\n\nmodule.exports = AuthController;\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst utils = require('./utils.js');\n\n/* global location */\n\n/**\n * Holds Pryv Service informations.\n *\n * It's returned by `service.assets()`\n *\n * @memberof pryv\n **/\nclass ServiceAssets {\n  /**\n   * Private => use ServiceAssets.setup()\n   * @param {Object} assets The content of service/info.assets properties.\n   * @param {string} assetsURL Url point to assets of the service of a Pryv platform\n   */\n  constructor (assets, assetsURL) {\n    this._assets = assets;\n    this._assetsURL = assetsURL;\n  }\n\n  /**\n   * Load Assets definition from URL\n   * @param {string} pryvServiceAssetsSourceUrl - URL to the assets definition JSON\n   * @returns {Promise<ServiceAssets>} Promise resolving to ServiceAssets instance\n   */\n  static async setup (pryvServiceAssetsSourceUrl) {\n    const { body } = await utils.fetchGet(pryvServiceAssetsSourceUrl);\n    return new ServiceAssets(body, pryvServiceAssetsSourceUrl);\n  }\n\n  /**\n   * get a value from path separated by `:`\n   * example of key `lib-js:buttonSignIn`\n   * @param {string} [keyPath] if null, will return the all assets\n   */\n  get (keyPath) {\n    let result = Object.assign({}, this._assets);\n    if (keyPath) {\n      keyPath.split(':').forEach((key) => {\n        result = result[key];\n        if (typeof result === 'undefined') return result;\n      });\n    }\n    return result;\n  }\n\n  /**\n   * get an Url from path separated by `:`\n   * identical to doing assets.relativeURL(assets.get(keyPath))\n   * example of key `lib-js:buttonSignIn`\n   * @param {string} [keyPath] if null, will return the all assets\n   */\n  getUrl (keyPath) {\n    const url = this.get(keyPath);\n    if (typeof url !== 'string') {\n      throw new Error(`Unexpected value for ${keyPath}: ${url}`);\n    }\n    return this.relativeURL(url);\n  }\n\n  /**\n   * get relativeUrl\n   */\n  relativeURL (url) {\n    return relPathToAbs(this._assets.baseUrl || this._assetsURL, url);\n  }\n\n  // ---------------- Default service resources\n\n  /**\n   * Set all defaults Favicon, CSS\n   */\n  async setAllDefaults () {\n    this.setFavicon();\n    await this.loadCSS();\n  }\n\n  /**\n   * Set service Favicon to Web Page\n   */\n  setFavicon () {\n    /** @type {HTMLLinkElement} */\n    // @ts-ignore - querySelector returns Element but we know it's HTMLLinkElement\n    const link = document.querySelector(\"link[rel*='icon']\") || document.createElement('link');\n    link.type = 'image/x-icon';\n    link.rel = 'shortcut icon';\n    link.href = this.relativeURL(this._assets.favicon.default.url);\n    document.getElementsByTagName('head')[0].appendChild(link);\n  }\n\n  /**\n   * Set default service CSS\n   */\n  async loadCSS () {\n    loadCSS(this.relativeURL(this._assets.css.default.url));\n  }\n\n  // ---- Login\n\n  /**\n   * Load CSS for Login button\n   */\n  async loginButtonLoadCSS () {\n    loadCSS(this.relativeURL(this._assets['lib-js'].buttonSignIn.css));\n  }\n\n  /**\n   * Get HTML for Login Button\n   * @returns {Promise<string>} Promise resolving to HTML string\n   */\n  async loginButtonGetHTML () {\n    const { text } = await utils.fetchGetText(this.relativeURL(this._assets['lib-js'].buttonSignIn.html));\n    return text;\n  }\n\n  /**\n   * Get Messages strings for Login Button\n   * @returns {Promise<Object.<string, string>>} Promise resolving to messages object\n   */\n  async loginButtonGetMessages () {\n    const { body } = await utils.fetchGet(this.relativeURL(this._assets['lib-js'].buttonSignIn.messages));\n    return body;\n  }\n}\n\nmodule.exports = ServiceAssets;\n\nfunction loadCSS (url) {\n  const head = document.getElementsByTagName('head')[0];\n  const link = document.createElement('link');\n  link.id = url;\n  link.rel = 'stylesheet';\n  link.type = 'text/css';\n  link.href = url;\n  link.media = 'all';\n  head.appendChild(link);\n}\n\n/* HACK: disabling linting until code is cleaned up */\n/* eslint-disable */\n\n  /*\\\n  |*| Modified version of\n  |*| :: translate relative paths to absolute paths ::\n  |*|\n  |*| https://developer.mozilla.org/en-US/docs/Web/API/document.cookie\n  |*|\n  |*| The following code is released under the GNU Public License, version 3 or later.\n  |*| http://www.gnu.org/licenses/gpl-3.0-standalone.html\n  |*|\n  \\*/\n\nfunction relPathToAbs (baseUrlString, sRelPath) {\n  /** @type {Location|HTMLAnchorElement} */\n  var baseLocation = location;\n  if (baseUrlString) {\n    // @ts-ignore - HTMLAnchorElement has compatible URL properties\n    baseLocation = document.createElement('a');\n    baseLocation.href = baseUrlString;\n  }\n\n  var nUpLn, sDir = \"\", sPath = baseLocation.pathname.replace(/[^\\/]*$/, sRelPath.replace(/(\\/|^)(?:\\.?\\/+)+/g, \"$1\"));\n  for (var nEnd, nStart = 0; nEnd = sPath.indexOf(\"/../\", nStart), nEnd > -1; nStart = nEnd + nUpLn) {\n    nUpLn = /^\\/(?:\\.\\.\\/)*/.exec(sPath.slice(nEnd))[0].length;\n    sDir = (sDir + sPath.substring(nStart, nEnd)).replace(new RegExp(\"(?:\\\\\\/+[^\\\\\\/]*){0,\" + ((nUpLn - 1) / 3) + \"}$\"),\n      \"/\");\n  }\n  const portStr = baseLocation.port ? ':' + baseLocation.port : '';\n  return baseLocation.protocol + '//' + baseLocation.hostname + portStr + sDir + sPath.substr(nStart);\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst utils = require('./utils.js');\n// Connection is required at the end of this file to allow circular requires.\nconst Assets = require('./ServiceAssets.js');\n\n/**\n * @class pryv.Service\n * A Pryv.io deployment is a unique \"Service\", as an example **Pryv Lab** is a service, deployed with the domain name **pryv.me**.\n *\n * `pryv.Service` exposes tools to interact with Pryv.io at a \"Platform\" level.\n *\n *  ##### Initizalization with a service info URL\n```js\nconst service = new pryv.Service('https://reg.pryv.me/service/info');\n```\n\n- With the content of a serviceInfo configuration\n\nService information properties can be overriden with specific values. This might be usefull to test new designs on production platforms.\n\n```js\nconst serviceInfoUrl = 'https://reg.pryv.me/service/info';\nconst serviceCustomizations = {\n  name: 'Pryv Lab 2',\n  assets: {\n    definitions: 'https://pryv.github.io/assets-pryv.me/index.json'\n  }\n}\nconst service = new pryv.Service(serviceInfoUrl, serviceCustomizations);\n```\n\n * @memberof pryv\n *\n * @constructor\n * @param {string} serviceInfoUrl Url point to /service/info of a Pryv platform see: {@link https://api.pryv.com/reference/#service-info}\n */\nclass Service {\n  constructor (serviceInfoUrl, serviceCustomizations) {\n    this._serviceInfo = null;\n    this._assets = null;\n    this._polling = false;\n    this._serviceInfoUrl = serviceInfoUrl;\n    this._pryvServiceCustomizations = serviceCustomizations;\n  }\n\n  /**\n   * Return service info parameters info known of fetch it if needed.\n   * Example\n   *  - name of a platform\n   *    `const serviceName = await service.info().name`\n   * @see ServiceInfo For details on available properties.\n   * @param {boolean} [forceFetch] If true, will force fetching service info.\n   * @returns {Promise<ServiceInfo>} Promise to Service info Object\n   */\n  async info (forceFetch) {\n    if (forceFetch || !this._serviceInfo) {\n      let baseServiceInfo = {};\n      if (this._serviceInfoUrl) {\n        const { body } = await utils.fetchGet(this._serviceInfoUrl);\n        baseServiceInfo = body;\n      }\n      Object.assign(baseServiceInfo, this._pryvServiceCustomizations);\n      // @ts-ignore - baseServiceInfo is populated from body or customizations\n      this.setServiceInfo(baseServiceInfo);\n    }\n    return this._serviceInfo;\n  }\n\n  /**\n   * Check if a service supports High Frequency Data Sets\n   * @returns {Promise<boolean>} Promise resolving to true if HF is supported\n   */\n  async supportsHF () {\n    const infos = await this.info();\n    return (infos.features == null || infos.features.noHF !== true);\n  }\n\n  /**\n   * Check if a service has username in the hostname or in the path of the API.\n   * @returns {Promise<boolean>} Promise resolving to true if the service does not rely on DNS to find a host related to a username\n   */\n  async isDnsLess () {\n    const infos = await this.info();\n    const hostname = infos.api.split('/')[2];\n    return !hostname.includes('{username}');\n  }\n\n  /**\n   * @private\n   * @param {ServiceInfo} serviceInfo\n   */\n  setServiceInfo (serviceInfo) {\n    if (!serviceInfo.name) {\n      throw new Error('Invalid data from service/info');\n    }\n    // cleanup serviceInfo for eventual url not finishing by \"/\"\n    // code will be obsolete with next version of register\n    ['access', 'api', 'register'].forEach((key) => {\n      if (serviceInfo[key].slice(-1) !== '/') {\n        serviceInfo[key] += '/';\n      }\n    });\n    this._serviceInfo = serviceInfo;\n  }\n\n  /**\n   * Return assets property content\n   * @param {boolean} [forceFetch] If true, will force fetching service info.\n   * @returns {Promise<ServiceAssets|null>} Promise to ServiceAssets\n   */\n  async assets (forceFetch) {\n    if (!forceFetch && this._assets) {\n      return this._assets;\n    } else {\n      const serviceInfo = await this.info();\n      if (!serviceInfo.assets || !serviceInfo.assets.definitions) {\n        console.log('Warning: no assets for this service');\n        return null;\n      }\n      this._assets = await Assets.setup(serviceInfo.assets.definitions);\n      return this._assets;\n    }\n  }\n\n  /**\n   * Return service info parameters info known or null if not yet loaded\n   * @returns {ServiceInfo} Service Info definition\n   */\n  infoSync () {\n    return this._serviceInfo;\n  }\n\n  /**\n   * Return an API endpoint from a username and token\n   * @param {string} username - The username\n   * @param {string} [token] - Optional authorization token\n   * @returns {Promise<APIEndpoint>} Promise resolving to the API endpoint URL\n   */\n  async apiEndpointFor (username, token) {\n    const serviceInfo = await this.info();\n    return Service.buildAPIEndpoint(serviceInfo, username, token);\n  }\n\n  /**\n   * Return an API endpoint from a username, token and ServiceInfo.\n   * This method is rarely used. See **apiEndpointFor** as an alternative.\n   * @param {ServiceInfo} serviceInfo - The service info object containing API URL template\n   * @param {string} username - The username\n   * @param {string} [token] - Optional authorization token\n   * @returns {APIEndpoint} The constructed API endpoint URL\n   */\n  static buildAPIEndpoint (serviceInfo, username, token) {\n    const endpoint = serviceInfo.api.replace('{username}', username);\n    return utils.buildAPIEndpoint({ endpoint, token });\n  }\n\n  /**\n   * Issue a \"login call on the Service\" return a Connection on success\n   * **! Warning**: the token of the connection will be a \"Personal\" token that expires\n   * @see https://api.pryv.com/reference-full/#login-user\n   * @param {string} username\n   * @param {string} password\n   * @param {string} appId\n   * @param {string} [originHeader=service-info.register] Only for Node.js. If not set will use the register value of service info. In browsers this will overridden by current page location.\n   * @throws {Error} on invalid login\n   */\n  async login (username, password, appId, originHeader) {\n    const apiEndpoint = await this.apiEndpointFor(username);\n\n    const headers = {};\n    originHeader = originHeader || (await this.info()).register;\n    if (!utils.isBrowser()) {\n      headers.Origin = originHeader;\n    }\n    const { response, body } = await utils.fetchPost(\n      apiEndpoint + 'auth/login',\n      { username, password, appId },\n      headers\n    );\n\n    if (!response.ok) {\n      if (body?.error?.message) {\n        throw new Error(body.error.message);\n      }\n      throw new Error('Login failed: ' + JSON.stringify(body));\n    }\n\n    if (!body.token) {\n      throw new Error('Invalid login response: ' + JSON.stringify(body));\n    }\n    return new Connection(\n      Service.buildAPIEndpoint(await this.info(), username, body.token),\n      this // Pre load Connection with service\n    );\n  }\n}\n\nmodule.exports = Service;\n\n// Require is done after exports to allow circular references\nconst Connection = require('./Connection');\n\n/**\n * Object to handle Pryv Service Informations https://api.pryv.com/reference/#service-info\n * @typedef {Object} ServiceInfo\n * @property {string} register The URL of the register service.\n * @property {string} access The URL of the access page.\n * @property {string} api The API endpoint format.\n * @property {string} name The platform name.\n * @property {string} home The URL of the platform's home page.\n * @property {string} support The email or URL of the support page.\n * @property {string} terms The terms and conditions, in plain text or the URL displaying them.\n * @property {string} eventTypes The URL of the list of validated event types.\n * @property {Object} [assets] Holder for service specific Assets (icons, css, ...)\n * @property {string} [assets.definitions] URL to json object with assets definitions\n * @property {Object} [features] Platform feature flags\n * @property {boolean} [features.noHF] True if HF data is not supported\n */\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nmodule.exports = get;\n\nconst Messages = {\n  LOADING: {\n    en: '...'\n  },\n  ERROR: {\n    en: 'Error',\n    fr: 'Erreur'\n  },\n  LOGIN: {\n    en: 'Signin',\n    fr: 'Login'\n  },\n  SIGNOUT_CONFIRM: {\n    en: 'Logout?',\n    fr: 'Se dÃ©connecter ?'\n  }\n};\n\nfunction get (languageCode, definitions) {\n  const myMessages = definitions || Messages;\n  const res = {};\n  Object.keys(myMessages).forEach((key) => {\n    res[key] = myMessages[key][languageCode] || myMessages[key].en;\n  });\n  return res;\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n// there two steps 1 find events, then eventDeletions\nconst EVENTMARKERS = ['\"events\":[', '\"eventDeletions\":['];\n\n/**\n * Stremed JSON parser for events\n */\nmodule.exports = function (foreachEvent, includeDeletions) {\n  let eventOrEventDeletions = 0; // start with event\n  let buffer = ''; // temp data\n  let body = null; // to be returned\n\n  // IN EVENTS VARS\n  let depth = 0; // level of depth in brackets\n  let inString = false; // cursor is in a String\n  let skipNextOne = false; // when a backslash is found\n  let cursorPos = 0; // position of Character Cursor\n\n  // counters\n  let eventsCount = 0;\n  let eventDeletionsCount = 0;\n\n  const states = {\n    A_BEFORE_EVENTS: 0,\n    B_IN_EVENTS: 1,\n    D_AFTER_EVENTS: 2\n  };\n\n  let state = states.A_BEFORE_EVENTS;\n\n  function processBuffer () {\n    switch (state) {\n      case states.A_BEFORE_EVENTS:\n        searchStartEvents();\n        break;\n      case states.B_IN_EVENTS:\n        processEvents();\n        break;\n      default:\n        afterEvents();\n        break;\n    }\n  }\n\n  function searchStartEvents () {\n    // search for \"events\": and happend any info before to the body\n    const n = buffer.indexOf(EVENTMARKERS[eventOrEventDeletions]);\n    if (n > 0) {\n      if (eventOrEventDeletions === 0) { // do only once\n        body = buffer.substring(0, n);\n      }\n      buffer = buffer.substr(n + EVENTMARKERS[eventOrEventDeletions].length);\n      state = states.B_IN_EVENTS;\n      processEvents();\n    }\n  }\n\n  function processEvents () {\n    /// ---- in Event\n    while (cursorPos < buffer.length && (state === states.B_IN_EVENTS)) {\n      if (skipNextOne) { // ignore next character\n        skipNextOne = false;\n        cursorPos++;\n        continue;\n      }\n      switch (buffer.charCodeAt(cursorPos)) {\n        case 93: // ]\n          if (depth === 0) { // end of events\n            if (cursorPos !== 0) {\n              throw new Error('Found trailling ] in mid-course');\n            }\n            if (eventOrEventDeletions === 0 && includeDeletions) {\n              state = states.A_BEFORE_EVENTS;\n              eventOrEventDeletions = 1; // now look for eventDeletions\n              return;\n            } else { // done\n              state = states.D_AFTER_EVENTS;\n              let eventsOrDeletionMsg = '';\n              if (eventOrEventDeletions === 1) {\n                eventsOrDeletionMsg = '\"eventDeletionsCount\":' + eventDeletionsCount + ',';\n              }\n              buffer = eventsOrDeletionMsg + '\"eventsCount\":' + eventsCount + '' + buffer.substr(1);\n            }\n          }\n          break;\n        case 92: // \\\n          skipNextOne = true;\n          break;\n        case 123: // {\n          if (!inString) depth++;\n          break;\n        case 34: // \"\n          inString = !inString;\n          break;\n        case 125: // }\n          if (!inString) depth--;\n          if (depth === 0) {\n            // ignore possible coma ',' if first char\n            const ignoreComa = (buffer.charCodeAt(0) === 44) ? 1 : 0;\n            const eventStr = buffer.substring(ignoreComa, cursorPos + 1);\n\n            if (eventOrEventDeletions === 0) {\n              eventsCount++;\n            } else {\n              eventDeletionsCount++;\n            }\n            buffer = buffer.substr(cursorPos + 1);\n            addEvent(eventStr);\n            cursorPos = -1;\n          }\n          break;\n      }\n      cursorPos++;\n    }\n  }\n\n  function afterEvents () {\n    // just happend the end of message;\n    body += buffer;\n    buffer = '';\n  }\n\n  return function (res, fn) {\n    res.setEncoding('utf8'); // Already UTF8 in browsers\n    res.on('data', chunk => {\n      buffer += chunk;\n      processBuffer();\n    });\n    res.on('end', () => {\n      let err;\n      let bodyObject;\n      try {\n        res.text = body + buffer;\n        bodyObject = res.text && JSON.parse(res.text);\n      } catch (err_) {\n        err = err_;\n        // issue #675: return the raw response if the response parsing fails\n        err.rawResponse = res.text || null;\n        // issue #876: return the http status code if the response parsing fails\n        err.statusCode = res.statusCode;\n      } finally {\n        fn(err, bodyObject);\n      }\n    });\n  };\n\n  /// --- Direct Push\n  function addEvent (strEvent) {\n    foreachEvent(JSON.parse(strEvent));\n  }\n};\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst LoginButton = require('./LoginButton');\nconst CookieUtils = require('./CookieUtils');\nconst utils = require('../utils');\n\n/**\n * @memberof pryv\n * @namespace pryv.Browser\n */\nmodule.exports = {\n  LoginButton,\n  CookieUtils,\n  // retro-compatibility for lib-js < 2.0.9\n  AuthStates: require('../Auth/AuthStates'),\n  setupAuth: require('../Auth').setupAuth,\n  serviceInfoFromUrl: getServiceInfoFromURL\n};\n\n/**\n * Util to grab parameters from url query string\n * @param {*} url\n */\nfunction getServiceInfoFromURL (url) {\n  const queryParams = utils.getQueryParamsFromURL(url || window.location.href);\n  return queryParams.pryvServiceInfoUrl;\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst regexAPIandToken = /(.+):\\/\\/(.+)@(.+)/gm;\nconst regexSchemaAndPath = /(.+):\\/\\/(.+)/gm;\n\n/**\n * Utilities to access Pryv API.\n * @memberof pryv\n * @namespace pryv.utils\n */\nconst utils = module.exports = {\n  /**\n   * Perform a GET request and parse JSON response\n   * @param {string} url - URL to fetch\n   * @param {Object} [queryParams={}] - Query parameters to append\n   * @param {Object} [headers={}] - Additional headers\n   * @returns {Promise<{response: Response, body: Object}>} Promise resolving to response and parsed body\n   */\n  async fetchGet (url, queryParams = {}, headers = {}) {\n    let queryStr = '';\n    if (queryParams && Object.keys(queryParams).length > 0) {\n      queryStr = '?' + new URLSearchParams(queryParams).toString();\n    }\n    const myHeaders = Object.assign({ Accept: 'application/json' }, headers);\n    const response = await fetch(url + queryStr, { headers: myHeaders });\n    const body = await response.json();\n    return { response, body };\n  },\n\n  /**\n   * Perform a GET request and return text response\n   * @param {string} url - URL to fetch\n   * @param {Object} [headers={}] - Additional headers\n   * @returns {Promise<{response: Response, text: string}>} Promise resolving to response and text body\n   */\n  async fetchGetText (url, headers = {}) {\n    const myHeaders = Object.assign({ Accept: 'text/html' }, headers);\n    const response = await fetch(url, { headers: myHeaders });\n    const text = await response.text();\n    return { response, text };\n  },\n\n  /**\n   * Perform a POST request with JSON data\n   * @param {string} url - URL to post to\n   * @param {Object} [data] - Data to send as JSON\n   * @param {Object} [headers={}] - Additional headers\n   * @returns {Promise<{response: Response, body: Object}>} Promise resolving to response and parsed body\n   */\n  async fetchPost (url, data, headers = {}) {\n    const myHeaders = Object.assign({\n      Accept: 'application/json',\n      'Content-Type': 'application/json'\n    }, headers);\n    const response = await fetch(url, {\n      method: 'POST',\n      headers: myHeaders,\n      body: JSON.stringify(data)\n    });\n    const body = await response.json();\n    return { response, body };\n  },\n\n  /**\n   * Returns true is run in a browser\n   * @memberof pryv.utils\n   * @returns {boolean}\n   */\n  isBrowser: function () {\n    return typeof window !== 'undefined' && typeof document !== 'undefined';\n  },\n\n  /**\n   * From a APIEndpoint URL, return an object (TokenAndAPI) with two properties\n   * @memberof pryv.utils\n   * @param {APIEndpoint} apiEndpoint\n   * @returns {TokenAndEndpoint}\n   */\n  extractTokenAndAPIEndpoint: function (apiEndpoint) {\n    regexAPIandToken.lastIndex = 0;\n    const res = regexAPIandToken.exec(apiEndpoint);\n\n    if (res !== null) { // has token\n      // add a trailing '/' to end point if missing\n      if (!res[3].endsWith('/')) {\n        res[3] += '/';\n      }\n      return { endpoint: res[1] + '://' + res[3], token: res[2] };\n    }\n    // else check if valid url\n    regexSchemaAndPath.lastIndex = 0;\n    const res2 = regexSchemaAndPath.exec(apiEndpoint);\n    if (res2 === null) {\n      throw new Error('Cannot find endpoint, invalid URL format');\n    }\n    // add a trailing '/' to end point if missing\n    if (!res2[2].endsWith('/')) {\n      res2[2] += '/';\n    }\n\n    return { endpoint: res2[1] + '://' + res2[2], token: null };\n  },\n\n  /**\n   * Get a APIEndpoint URL from a TokenAndAPI object\n   * @memberof pryv.utils\n   * @param {TokenAndEndpoint} tokenAndAPI\n   * @returns {APIEndpoint}\n   */\n  buildAPIEndpoint: function (tokenAndAPI) {\n    if (!tokenAndAPI.token) {\n      let res = tokenAndAPI.endpoint + '';\n      if (!tokenAndAPI.endpoint.endsWith('/')) {\n        res += '/';\n      }\n      return res;\n    }\n    regexSchemaAndPath.lastIndex = 0;\n    const res = regexSchemaAndPath.exec(tokenAndAPI.endpoint);\n    // add a trailing '/' to end point if missing\n    if (!res[2].endsWith('/')) {\n      res[2] += '/';\n    }\n    return res[1] + '://' + tokenAndAPI.token + '@' + res[2];\n  },\n\n  /**\n   * Check if the browser is running on a mobile device or tablet\n   * @memberof pryv.utils\n   * @param {string|Navigator} [navigator] - Navigator object or user agent string (for testing)\n   * @returns {boolean} True if mobile or tablet\n   */\n  browserIsMobileOrTablet: function (navigator) {\n    if (navigator == null) {\n      return false;\n    }\n    let check = false;\n    // @ts-ignore - navigator is Navigator when not null\n    // eslint-disable-next-line no-useless-escape\n    (function (a) { if (/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || navigator.opera);\n    return check;\n  },\n\n  /**\n   * Remove Pryv-specific query parameters from URL\n   * @memberof pryv.utils\n   * @param {string} url - URL to clean\n   * @returns {string} URL without prYv* parameters\n   */\n  cleanURLFromPrYvParams: function (url) {\n    const PRYV_REGEXP = /[?#&]+prYv([^=&]+)=([^&]*)/g;\n    return url.replace(PRYV_REGEXP, '');\n  },\n\n  /**\n   * Extract query parameters from a URL\n   * @memberof pryv.utils\n   * @param {string} url - URL to parse\n   * @returns {Object.<string, string>} Object with key-value pairs of query parameters\n   */\n  getQueryParamsFromURL: function (url) {\n    /** @type {Object.<string, string>} */\n    const vars = {};\n    const QUERY_REGEXP = /[?#&]+([^=&]+)=([^&]*)/g;\n    url.replace(QUERY_REGEXP,\n      // @ts-ignore - replace callback is used for side effects\n      function (m, key, value) {\n        vars[key] = decodeURIComponent(value);\n      });\n    return vars;\n  }\n};\n\n// TODO: remove following deprecated aliases with next major version\n\n/**\n * @deprecated Renamed to `extractTokenAndAPIEndpoint()`\n */\nutils.extractTokenAndApiEndpoint = utils.extractTokenAndAPIEndpoint;\n\n/**\n * @deprecated Renamed to `buildAPIEndpoint()`\n */\n// TODO: remove deprecated alias with next major version\nutils.buildPryvApiEndpoint = utils.buildAPIEndpoint;\n\n// --------------- typedfs ------------------------------- //\n\n/**\n * An object with two properties: token & apiEndpoint\n * @typedef {Object} TokenAndEndpoint\n * @property {string} [token] Authorization token\n * @property {string} endpoint url of API endpoint\n */\n\n/**\n * A String url of the form http(s)://{token}@{apiEndpoint}\n * @typedef {string} APIEndpoint\n */\n\n/**\n * Common Meta are returned by each standard call on the API https://api.pryv.com/reference/#in-method-results\n * @typedef {Object} CommonMeta\n * @property {string} apiVersion The version of the API in the form {major}.{minor}.{revision}. Mirrored in HTTP header API-Version.\n * @property {number} serverTime The current server time as a timestamp in second. Keeping track of server time is necessary to properly handle time in API calls.\n * @property {string} serial The serial will change every time the core or register is updated. If you compare it with the serial of a previous response and notice a difference, you should reload the service information.\n */\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n/**\n * The possible auth states:\n * ERROR, LOADING, INITIALIZED, NEED_SIGNIN, AUTHORIZED, SIGNOUT, REFUSED\n * @readonly\n * @enum {string}\n * @memberof pryv.Browser\n */\nmodule.exports = {\n  ERROR: 'ERROR',\n  LOADING: 'LOADING',\n  INITIALIZED: 'INITIALIZED',\n  NEED_SIGNIN: 'NEED_SIGNIN',\n  AUTHORIZED: 'ACCEPTED',\n  SIGNOUT: 'SIGNOUT',\n  REFUSED: 'REFUSED'\n};\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst AuthController = require('./AuthController');\nconst AuthStates = require('./AuthStates');\nconst LoginButton = require('../Browser/LoginButton');\nconst Service = require('../Service');\n\n/**\n * @memberof pryv\n * @namespace pryv.Auth\n */\nmodule.exports = {\n  setupAuth,\n  AuthStates,\n  AuthController\n};\n\n/**\n * Start an authentication process\n *\n * @memberof pryv.Auth\n * @param {Object} settings\n * @param {Object} settings.authRequest See https://api.pryv.com/reference/#data-structure-access\n * @param {string} [settings.authRequest.languageCode] Language code, as per LoginButton Messages: 'en', 'fr\n * @param {string} settings.authRequest.requestingAppId Application id, ex: 'my-app'\n * @param {Object} settings.authRequest.requestedPermissions\n * @param {string | boolean} settings.authRequest.returnURL : false, // set this if you don't want a popup\n * @param {string} [settings.authRequest.referer] To track registration source\n * @param {string} settings.spanButtonID set and <span> id in DOM to insert default login button or null for custom\n * @param {Function} settings.onStateChange\n * @param {string} [settings.returnURL] Set to \"self#\" to disable popup and force using the same page\n * @param {string} serviceInfoUrl\n * @param {Object} [serviceCustomizations] override properties of serviceInfoUrl\n * @returns {Promise<Service>}\n */\nasync function setupAuth (settings, serviceInfoUrl, serviceCustomizations, HumanInteraction = LoginButton) {\n  const service = new Service(serviceInfoUrl, serviceCustomizations);\n  await service.info();\n\n  const humanInteraction = new HumanInteraction(settings, service);\n  await humanInteraction.init();\n\n  return service;\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst utils = require('./utils.js');\nconst jsonParser = require('./lib/json-parser');\nconst libGetEventStreamed = require('./lib/getEventStreamed');\nconst PryvError = require('./lib/PryvError');\n\n/**\n * @class Connection\n * A connection is an authenticated link to a Pryv.io account.\n *\n * @type {TokenAndEndpoint}\n *\n * @example\n * create a connection for the user 'tom' on 'pryv.me' backend with the token 'TTZycvBTiq'\n * const conn = new pryv.Connection('https://TTZycvBTiq@tom.pryv.me');\n *\n * @property {string} [token]\n * @property {string} endpoint\n * @memberof pryv\n *\n * @constructor\n * @this {Connection}\n * @param {APIEndpoint} apiEndpoint\n * @param {pryv.Service} [service] - eventually initialize Connection with a Service\n */\nclass Connection {\n  constructor (apiEndpoint, service) {\n    const { token, endpoint } = utils.extractTokenAndAPIEndpoint(apiEndpoint);\n    this.token = token;\n    this.endpoint = endpoint;\n    this.options = {};\n    this.options.chunkSize = 1000;\n    this._deltaTime = { value: 0, weight: 0 };\n    if (service && !(service instanceof Service)) {\n      throw new Error('Invalid service param');\n    }\n    this._service = service;\n  }\n\n  /**\n   * get pryv.Service object relative to this connection\n   * @readonly\n   * @property {pryv.Service} service\n   */\n  get service () {\n    if (this._service) return this._service;\n    this._service = new Service(this.endpoint + 'service/info');\n    return this._service;\n  }\n\n  /**\n   * Get username for this connection.\n   * It's async as it's constructed from access info.\n   * @returns {Promise<string>} Promise resolving to the username\n   */\n  async username () {\n    const accessInfo = await this.accessInfo();\n    if (accessInfo.error) {\n      throw new PryvError(\n        'Failed fetching accessinfo: ' + accessInfo.error.message,\n        accessInfo.error\n      );\n    }\n    // @ts-ignore - username is always a string\n    return accessInfo.user.username;\n  }\n\n  /**\n   * Get access info for this connection.\n   * It's async as it is fetched from the API.\n   * @returns {Promise<AccessInfo>} Promise resolving to the access info\n   */\n  async accessInfo () {\n    return this.get('access-info', null);\n  }\n\n  /**\n   * Issue a Batch call https://api.pryv.com/reference/#call-batch .\n   * arrayOfAPICalls will be splited in multiple calls if the size is > `conn.options.chunkSize` .\n   * Default chunksize is 1000.\n   * @param {Array.<MethodCall>} arrayOfAPICalls Array of Method Calls\n   * @param {Function} [progress] Return percentage of progress (0 - 100);\n   * @returns {Promise<Array>} Promise to Array of results matching each method call in order\n   */\n  async api (arrayOfAPICalls, progress) {\n    function httpHandler (batchCall) {\n      return this.post('', batchCall);\n    }\n    return await this._chunkedBatchCall(\n      arrayOfAPICalls,\n      progress,\n      httpHandler.bind(this)\n    );\n  }\n\n  /**\n   * Make one API call\n   * @param {string} method - Method ID (e.g., 'events.get', 'streams.create')\n   * @param {Object|Array} [params={}] - The params associated with this method\n   * @param {string} [expectedKey] - If given, returns the value of this key or throws an error if not present\n   * @returns {Promise<Object>} Promise resolving to the API result or the value of expectedKey\n   * @throws {Error} If .error is present in the response or expectedKey is missing\n   */\n  async apiOne (method, params = {}, expectedKey) {\n    const result = await this.api([{ method, params }]);\n    if (\n      result[0] == null ||\n      result[0].error ||\n      (expectedKey != null && result[0][expectedKey] == null)\n    ) {\n      const innerObject = result[0]?.error || result;\n      throw new PryvError(\n        `Error for api method: \"${method}\" with params: ${JSON.stringify(\n          params\n        )} >> Result: ${JSON.stringify(innerObject)}\"`,\n        innerObject\n      );\n    }\n    if (expectedKey != null) return result[0][expectedKey];\n    return result[0];\n  }\n\n  /**\n   * Revoke : Delete the accessId\n   * - Do not throw error if access is already revoked, just return null;\n   * @param {boolean} [throwOnFail=true] - if set to false do not throw Error on failure\n   * @param {Connection} [usingConnection] - specify which connection issues the revoke, might be necessary when selfRevoke\n   * @returns {Promise<Object|null>} Promise resolving to deletion result or null if already revoked/failed\n   */\n  async revoke (throwOnFail = true, usingConnection) {\n    usingConnection = usingConnection || this;\n    let accessInfo = null;\n    // get accessId\n    try {\n      accessInfo = await this.accessInfo();\n    } catch (e) {\n      if (e.response?.body?.error?.id === 'invalid-access-token') {\n        return null; // Already revoked OK..\n      }\n      if (throwOnFail) throw e;\n      return null;\n    }\n    // delete access\n    try {\n      const result = usingConnection.apiOne('accesses.delete', {\n        id: accessInfo.id\n      });\n      return result;\n    } catch (e) {\n      if (throwOnFail) throw e;\n      return null;\n    }\n  }\n\n  /**\n   * @private\n   */\n  async _chunkedBatchCall (arrayOfAPICalls, progress, callHandler) {\n    if (!Array.isArray(arrayOfAPICalls)) {\n      throw new Error('Connection.api() takes an array as input');\n    }\n\n    const res = [];\n    let percent = 0;\n    for (\n      let cursor = 0;\n      arrayOfAPICalls.length >= cursor;\n      cursor += this.options.chunkSize\n    ) {\n      const thisBatch = [];\n      const cursorMax = Math.min(\n        cursor + this.options.chunkSize,\n        arrayOfAPICalls.length\n      );\n      // copy only method and params into a back call to be exuted\n      for (let i = cursor; i < cursorMax; i++) {\n        thisBatch.push({\n          method: arrayOfAPICalls[i].method,\n          params: arrayOfAPICalls[i].params\n        });\n      }\n      const resRequest = await callHandler(thisBatch);\n      // result checks\n      if (!resRequest || !Array.isArray(resRequest.results)) {\n        throw new Error(\n          'API call result is not an Array: ' + JSON.stringify(resRequest)\n        );\n      }\n      if (resRequest.results.length !== thisBatch.length) {\n        throw new Error(\n          'API call result Array does not match request: ' +\n            JSON.stringify(resRequest)\n        );\n      }\n\n      // eventually call handleResult\n      for (let i = 0; i < resRequest.results.length; i++) {\n        if (arrayOfAPICalls[i + cursor].handleResult) {\n          await arrayOfAPICalls[i + cursor].handleResult.call(\n            null,\n            resRequest.results[i],\n            thisBatch[i] // request\n          );\n        }\n      }\n      Array.prototype.push.apply(res, resRequest.results);\n      percent = Math.round((100 * res.length) / arrayOfAPICalls.length);\n      if (progress) {\n        progress(percent, res);\n      }\n    }\n    return res;\n  }\n\n  /**\n   * Post to API and return results\n   * @param {string} path - API path\n   * @param {(Array | Object)} data - Data to post\n   * @returns {Promise<Object|Object[]>} Promise to result.body\n   */\n  async post (path, data) {\n    const now = getTimestamp();\n    const res = await this._postFetch(path, data);\n    this._handleMeta(res.body, now);\n    return res.body;\n  }\n\n  /**\n   * @private\n   * Post object as JSON to API\n   * @param {string} path - API path\n   * @param {Array | Object} data - Data to post as JSON\n   * @returns {Promise<{response: Response, body: Object|Object[]}>} Promise to response and body\n   */\n  async _postFetch (path, data) {\n    return this._postFetchRaw(path, JSON.stringify(data), 'application/json');\n  }\n\n  /**\n   * @private\n   * Raw Post to API\n   * @param {string} path - API path\n   * @param {any} data - Raw data to post\n   * @param {string} [contentType] - Content-Type header (optional, allows fetch to set it for FormData)\n   * @returns {Promise<{response: Response, body: Object|Object[]}>} Promise to response and body\n   */\n  async _postFetchRaw (path, data, contentType) {\n    const headers = {\n      Authorization: this.token,\n      Accept: 'application/json'\n    };\n    // optional for form-data llowing fetch to\n    // automatically set multipart/form-data with the correct boundary\n    if (contentType) {\n      headers['Content-Type'] = contentType;\n    }\n    const response = await fetch(this.endpoint + path, {\n      method: 'POST',\n      headers,\n      body: data\n    });\n    const body = await response.json();\n    return { response, body };\n  }\n\n  /**\n   * GET from API and return results\n   * @param {string} path - API path\n   * @param {Object} [queryParams] - Query parameters\n   * @returns {Promise<Object|Object[]>} Promise to result.body\n   */\n  async get (path, queryParams) {\n    const now = getTimestamp();\n    const res = await this._getFetchRaw(path, queryParams);\n    this._handleMeta(res.body, now);\n    return res.body;\n  }\n\n  /**\n   * @private\n   * Raw GET from API\n   * @param {string} path - API path\n   * @param {Object} [queryParams={}] - Query parameters\n   * @returns {Promise<{response: Response, body: Object|Object[]}>} Promise to response and body\n   */\n  async _getFetchRaw (path, queryParams = {}) {\n    path = path || '';\n    let queryStr = '';\n    if (queryParams && Object.keys(queryParams).length > 0) {\n      queryStr = '?' + new URLSearchParams(queryParams).toString();\n    }\n    const response = await fetch(this.endpoint + path + queryStr, {\n      headers: {\n        Authorization: this.token,\n        Accept: 'application/json'\n      }\n    });\n    const body = await response.json();\n    return { response, body };\n  }\n\n  /**\n   * Add data points to an HF (High Frequency) series event (flatJSON format)\n   * @param {string} eventId - The HF event ID\n   * @param {string[]} fields - Array of field names for the series\n   * @param {Array<Array<number|string>>} points - Array of data points, each point is an array of values\n   * @returns {Promise<HFSeriesAddResult>} Promise resolving to status response\n   * @see https://api.pryv.com/reference/#add-hf-series-data-points\n   */\n  async addPointsToHFEvent (eventId, fields, points) {\n    const res = await this.post('events/' + eventId + '/series', {\n      format: 'flatJSON',\n      fields,\n      points\n    });\n    if (res.status !== 'ok') {\n      throw new Error('Failed loading serie: ' + JSON.stringify(res.status));\n    }\n    return res;\n  }\n\n  /**\n   * Streamed get Event.\n   * @see https://api.pryv.com/reference/#get-events\n   * @param {Object} queryParams See `events.get` parameters\n   * @param {Function} forEachEvent Function taking one event as parameter. Will be called for each event\n   * @returns {Promise<Object>} Promise to result.body transformed with `eventsCount: {count}` replacing `events: [...]`\n   */\n  async getEventsStreamed (queryParams, forEachEvent) {\n    const myParser = jsonParser(forEachEvent, queryParams.includeDeletions);\n    const res = await libGetEventStreamed(this, queryParams, myParser);\n    const now = getTimestamp();\n    this._handleMeta(res.body, now);\n    return res.body;\n  }\n\n  /**\n   * Create an event with attached file\n   * NODE.jS ONLY\n   * @param {Event} event\n   * @param {string} filePath\n   */\n  async createEventWithFile (event, filePath) {\n    const fs = require('fs');\n    const path = require('path');\n\n    if (!fs || !path) {\n      throw new Error('createEventWithFile is only available in Node.js. Use createEventWithFormData in browser.');\n    }\n\n    const fileName = path.basename(filePath);\n    const mimeType = getMimeType(path.extname(filePath));\n    const fileBlob = await fs.openAsBlob(filePath, { type: mimeType });\n\n    const formData = new FormData();\n    formData.append('event', JSON.stringify(event));\n    formData.append('file', fileBlob, fileName);\n\n    const now = getTimestamp();\n    const { body } = await this._postFetchRaw('events', formData);\n    this._handleMeta(body, now);\n    return body;\n  }\n\n  /**\n   * Create an event from a Buffer\n   * @param {Object} event\n   * @param {Buffer|Blob} bufferData - Buffer for node, Blob for browser\n   * @param {string} filename\n   */\n  async createEventWithFileFromBuffer (event, bufferData, filename) {\n    const mimeType = getMimeType(getExtname(filename));\n    const fileBlob = bufferData instanceof Blob\n      ? bufferData\n      // @ts-ignore - Buffer is valid for Blob in Node.js\n      : new Blob([bufferData], { type: mimeType });\n\n    const formData = new FormData();\n    formData.append('file', fileBlob, filename);\n    const body = await this.createEventWithFormData(event, formData);\n    return body;\n  }\n\n  /**\n   * Create an event with attached formData\n   * !! BROWSER ONLY\n   * @param {Event} event\n   * @param {FormData} formData https://developer.mozilla.org/en-US/docs/Web/API/FormData/FormData\n   */\n  async createEventWithFormData (event, formData) {\n    formData.append('event', JSON.stringify(event));\n    const { body } = await this._postFetchRaw('events', formData);\n    return body;\n  }\n\n  /**\n   * Difference in seconds between the Pryv.io API and local time\n   * deltaTime is refined at each (non-raw) API call\n   * @readonly\n   * @property {number} deltaTime\n   */\n  get deltaTime () {\n    return this._deltaTime.value;\n  }\n\n  /**\n   * API endpoint of this connection (includes token if present)\n   * @readonly\n   * @property {APIEndpoint} apiEndpoint\n   */\n  get apiEndpoint () {\n    return utils.buildAPIEndpoint(this);\n  }\n\n  // private method that handle meta data parsing\n  _handleMeta (res, requestLocalTimestamp) {\n    if (!res.meta) throw new Error('Cannot find .meta in response.');\n    if (!res.meta.serverTime) { throw new Error('Cannot find .meta.serverTime in response.'); }\n\n    // update deltaTime and weight it\n    this._deltaTime.value =\n      (this._deltaTime.value * this._deltaTime.weight +\n        res.meta.serverTime -\n        requestLocalTimestamp) /\n      ++this._deltaTime.weight;\n  }\n}\n\nmodule.exports = Connection;\n\nfunction getTimestamp () {\n  return Date.now() / 1000;\n}\n\nconst MIME_TYPES = {\n  '.png': 'image/png',\n  '.jpg': 'image/jpeg',\n  '.jpeg': 'image/jpeg',\n  '.gif': 'image/gif',\n  '.webp': 'image/webp',\n  '.svg': 'image/svg+xml',\n  '.bmp': 'image/bmp',\n  '.ico': 'image/x-icon',\n  '.pdf': 'application/pdf',\n  '.json': 'application/json',\n  '.xml': 'application/xml',\n  '.zip': 'application/zip',\n  '.gz': 'application/gzip',\n  '.tar': 'application/x-tar',\n  '.txt': 'text/plain',\n  '.html': 'text/html',\n  '.htm': 'text/html',\n  '.css': 'text/css',\n  '.js': 'application/javascript',\n  '.mjs': 'application/javascript',\n  '.mp3': 'audio/mpeg',\n  '.wav': 'audio/wav',\n  '.ogg': 'audio/ogg',\n  '.mp4': 'video/mp4',\n  '.webm': 'video/webm',\n  '.avi': 'video/x-msvideo',\n  '.mov': 'video/quicktime'\n};\n\nfunction getMimeType (ext) {\n  return MIME_TYPES[ext.toLowerCase()] || 'application/octet-stream';\n}\n\nfunction getExtname (filename) {\n  const lastDot = filename.lastIndexOf('.');\n  return lastDot >= 0 ? filename.slice(lastDot) : '';\n}\n\n// service is require \"after\" to allow circular require\nconst Service = require('./Service');\n\n/**\n * API Method call, for batch call https://api.pryv.com/reference/#call-batch\n * @typedef {Object} MethodCall\n * @property {string} method - The method id\n * @property {(Object|Array)}  params - The call parameters as required by the method.\n * @property {(Function|Promise)} [handleResult] - Will be called with the result corresponding to this specific call.\n */\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n/* global fetch */\n\nmodule.exports = getEventStreamed;\n\nasync function getEventStreamed (conn, queryParam, parser) {\n  /**\n   * Holds Parser's settings\n   */\n  const parserSettings = {\n    ondata: null,\n    onend: null,\n    encoding: 'utf8'\n  };\n\n  /**\n   * Mock Response\n   */\n  const fakeRes = {\n    setEncoding: function (encoding) {\n      parserSettings.encoding = encoding;\n    }, // will receive 'data' and 'end' callbacks\n    on: function (key, f) {\n      parserSettings['on' + key] = f;\n    }\n  };\n\n  /**\n   * Holds results from the parser\n   */\n  let errResult;\n  let bodyObjectResult;\n  /**\n   *\n   */\n  parser(fakeRes, function (err, bodyObject) {\n    errResult = err;\n    bodyObjectResult = bodyObject;\n  });\n\n  // ------------   fetch ------------------- //\n  const url = new URL(conn.endpoint + 'events');\n  url.search = new URLSearchParams(queryParam).toString();\n  const fetchParams = { method: 'GET', headers: { Accept: 'application/json' } };\n  if (conn.token) fetchParams.headers.Authorization = conn.token;\n\n  const response = await fetch(url, fetchParams);\n  const reader = response.body.getReader();\n\n  while (true) {\n    const { done, value } = await reader.read();\n    parserSettings.ondata(new TextDecoder(parserSettings.encoding).decode(value));\n    if (done) { parserSettings.onend(); break; }\n  }\n\n  if (errResult) {\n    throw new Error(errResult);\n  }\n\n  // We're done!\n  const result = {\n    text: fakeRes.text, // from the parser\n    body: bodyObjectResult, // from the parser\n    statusCode: response.status,\n    headers: {}\n  };\n  // add headers to result\n  // @ts-ignore - Headers.entries() exists in modern environments\n  for (const pair of response.headers.entries()) {\n    result.headers[pair[0]] = pair[1];\n  }\n\n  return result;\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\nconst Cookies = require('./CookieUtils');\nconst AuthStates = require('../Auth/AuthStates');\nconst AuthController = require('../Auth/AuthController');\nconst Messages = require('../Auth/LoginMessages');\nconst utils = require('../utils');\n\n/* global location, confirm */\n\n/**\n * @memberof pryv.Browser\n */\nclass LoginButton {\n  constructor (authSettings, service) {\n    this.authSettings = authSettings;\n    this.service = service;\n    this.serviceInfo = service.infoSync();\n  }\n\n  /**\n   * setup button and load assets\n   */\n  async init () {\n    // initialize button visuals\n    setupButton(this);\n    this.languageCode = this.authSettings.authRequest.languageCode || 'en';\n    this.messages = Messages(this.languageCode);\n    // @ts-ignore - loginButtonText is set by setupButton\n    if (this.loginButtonText) {\n      await loadAssets(this);\n    }\n    // set cookie key for authorization data\n    this._cookieKey = 'pryv-libjs-' + this.authSettings.authRequest.requestingAppId;\n\n    // initialize controller\n    this.auth = new AuthController(this.authSettings, this.service, this);\n    await this.auth.init();\n\n    return this.service;\n  }\n\n  onClick () {\n    this.auth.handleClick();\n  }\n\n  async onStateChange (state) {\n    switch (state.status) {\n      case AuthStates.LOADING:\n        this.text = getLoadingMessage(this);\n        break;\n      case AuthStates.INITIALIZED:\n        this.text = getInitializedMessage(this, this.serviceInfo.name);\n        break;\n      case AuthStates.NEED_SIGNIN: {\n        const loginUrl = state.authUrl || state.url; // url is deprecated\n        if (this.authSettings.authRequest.returnURL) { // open on same page (no Popup)\n          location.href = loginUrl;\n          return;\n        } else {\n          startLoginScreen(this, loginUrl);\n        }\n        break;\n      }\n      case AuthStates.AUTHORIZED:\n        this.text = state.username;\n        this.saveAuthorizationData({\n          apiEndpoint: state.apiEndpoint,\n          username: state.username\n        });\n        break;\n      case AuthStates.SIGNOUT: {\n        const message = this.messages.SIGNOUT_CONFIRM ? this.messages.SIGNOUT_CONFIRM : 'Logout ?';\n        if (confirm(message)) {\n          this.deleteAuthorizationData();\n          this.auth.init();\n        }\n        break;\n      }\n      case AuthStates.ERROR:\n        this.text = getErrorMessage(this, state.message);\n        break;\n      default:\n        console.log('WARNING Unhandled state for Login: ' + state.status);\n    }\n    // @ts-ignore - loginButtonText is set by setupButton\n    if (this.loginButtonText) {\n      // @ts-ignore\n      this.loginButtonText.innerHTML = this.text;\n    }\n  }\n\n  getAuthorizationData () {\n    return Cookies.get(this._cookieKey);\n  }\n\n  saveAuthorizationData (authData) {\n    Cookies.set(this._cookieKey, authData);\n  }\n\n  async deleteAuthorizationData () {\n    Cookies.del(this._cookieKey);\n  }\n\n  /**\n   * not mandatory to implement as non-browsers don't have this behaviour\n   * @param {*} authController\n   */\n  async finishAuthProcessAfterRedirection (authController) {\n    // this step should be applied only for the browser\n    if (!utils.isBrowser()) return;\n\n    // 3. Check if there is a prYvkey as result of \"out of page login\"\n    const url = window.location.href;\n    const pollUrl = retrievePollUrl(url);\n    if (pollUrl !== null) {\n      try {\n        const { body } = await utils.fetchGet(pollUrl);\n        authController.state = body;\n      } catch (e) {\n        authController.state = {\n          status: AuthStates.ERROR,\n          message: 'Cannot fetch result',\n          error: e\n        };\n      }\n    }\n\n    function retrievePollUrl (url) {\n      const params = utils.getQueryParamsFromURL(url);\n      let pollUrl = null;\n      if (params.prYvkey) { // deprecated method - To be removed\n        pollUrl = authController.serviceInfo.access + params.prYvkey;\n      }\n      if (params.prYvpoll) {\n        pollUrl = params.prYvpoll;\n      }\n      return pollUrl;\n    }\n  }\n}\n\nmodule.exports = LoginButton;\n\nasync function startLoginScreen (loginButton, authUrl) {\n  const screenX = typeof window.screenX !== 'undefined' ? window.screenX : window.screenLeft;\n  const screenY = typeof window.screenY !== 'undefined' ? window.screenY : window.screenTop;\n  const outerWidth = typeof window.outerWidth !== 'undefined' ? window.outerWidth : document.body.clientWidth;\n  const outerHeight = typeof window.outerHeight !== 'undefined' ? window.outerHeight : (document.body.clientHeight - 22);\n  const width = 400;\n  const height = 620;\n  const left = Math.floor(screenX + ((outerWidth - width) / 2));\n  const top = Math.floor(screenY + ((outerHeight - height) / 2.5));\n  const features = (\n    'width=' + width +\n    ',height=' + height +\n    ',left=' + left +\n    ',top=' + top +\n    ',scrollbars=yes'\n  );\n  loginButton.popup = window.open(authUrl, 'prYv Sign-in', features);\n\n  if (!loginButton.popup) {\n    // loginButton.auth.stopAuthRequest('FAILED_TO_OPEN_WINDOW');\n    console.log('Pop-up blocked. A second click should allow it.');\n  } else if (window.focus) {\n    loginButton.popup.focus();\n  }\n}\n\nfunction setupButton (loginBtn) {\n  loginBtn.loginButtonSpan = document.getElementById(loginBtn.authSettings.spanButtonID);\n\n  if (!loginBtn.loginButtonSpan) {\n    console.log('WARNING: pryv.Browser initialized with no spanButtonID');\n  } else {\n    // up to the time the button is loaded use the Span to display eventual\n    // error messages\n    loginBtn.loginButtonText = loginBtn.loginButtonSpan;\n\n    // bind actions dynamically to the button click\n    loginBtn.loginButtonSpan.addEventListener('click', loginBtn.onClick.bind(loginBtn));\n  }\n}\n\n/**\n * Loads the style from the service info\n */\nasync function loadAssets (loginBtn) {\n  const assets = await loginBtn.service.assets();\n  loginBtn.loginButtonSpan.innerHTML = await assets.loginButtonGetHTML();\n  loginBtn.loginButtonText = document.getElementById('pryv-access-btn-text');\n}\n\nfunction getErrorMessage (loginButton, message) {\n  return loginButton.messages.ERROR + ': ' + message;\n}\n\nfunction getLoadingMessage (loginButton) {\n  return loginButton.messages.LOADING;\n}\n\nfunction getInitializedMessage (loginButton, serviceName) {\n  return loginButton.messages.LOGIN + ': ' + serviceName;\n}\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n\n/**\n * Custom error class for Pryv library errors.\n * Includes an innerObject property for wrapping underlying errors.\n * @extends Error\n */\nclass PryvError extends Error {\n  /**\n   * Create a PryvError\n   * @param {string} message - Error message\n   * @param {Error|Object} [innerObject] - The underlying error or object that caused this error\n   */\n  constructor (message, innerObject) {\n    super(message);\n    this.name = 'PryvError';\n    /** @type {Error|Object|undefined} */\n    this.innerObject = innerObject;\n\n    // Maintains proper stack trace for where error was thrown (only in V8)\n    if (Error.captureStackTrace) {\n      Error.captureStackTrace(this, PryvError);\n    }\n  }\n}\n\nmodule.exports = PryvError;\n","/**\n * @license\n * [BSD-3-Clause](https://github.com/pryv/lib-js/blob/master/LICENSE)\n */\n/**\n * `pryv` library\n * @exports pryv\n * @property {pryv.Service} Service - To interact with Pryv.io at a \"Platform level\"\n * @property {pryv.Connection} Connection - To interact with an individual's (user) data set\n * @property {pryv.Browser} Browser - Browser Tools - Access request helpers and visuals (button)\n * @property {pryv.utils} utils - Exposes some utils for HTTP calls and tools to manipulate Pryv's API endpoints\n * @property {pryv.PryvError} PryvError - Custom error class with innerObject support\n */\nmodule.exports = {\n  Service: require('./Service'),\n  Connection: require('./Connection'),\n  Auth: require('./Auth'),\n  Browser: require('./Browser'),\n  utils: require('./utils'),\n  PryvError: require('./lib/PryvError'),\n  version: require('../package.json').version\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(1870);\n"],"names":["utils","set","cookieKey","value","expireInDays","isBrowser","myDate","Date","hostName","window","location","hostname","path","pathname","setDate","getDate","cookieStr","encodeURIComponent","JSON","stringify","toUTCString","document","cookie","module","exports","get","name","parts","split","length","parse","decodeURIComponent","pop","shift","del","deleted","g","Pryv","AuthStates","Messages","constructor","settings","service","loginButton","this","Error","authRequest","returnURL","getReturnURL","requestingAppId","requestedPermissions","call","stateChangeListeners","onStateChange","push","languageCode","messages","init","serviceInfo","infoSync","state","status","LOADING","assets","async","authController","loadedAssets","loginButtonLoadCSS","thisMessages","loginButtonGetMessages","console","log","e","ERROR","message","error","loadAssets","bind","storedCredentials","getAuthorizationData","Object","assign","AUTHORIZED","checkAutoLogin","INITIALIZED","finishAuthProcessAfterRedirection","stopAuthRequest","msg","handleClick","startAuthRequest","NEED_SIGNIN","_state","SIGNOUT","windowLocationForTest","navigatorForTests","RETURN_URL_AUTO","trailer","slice","indexOf","returnUrlIsAuto","browserIsMobileOrTablet","href","substring","cleanURLFromPrYvParams","response","body","fetchPost","access","ok","doPolling","pollResponse","pollUrl","fetchGet","pollAccess","poll","setTimeout","poll_rate_ms","newState","id","forEach","listener","ServiceAssets","assetsURL","_assets","_assetsURL","setup","pryvServiceAssetsSourceUrl","keyPath","result","key","getUrl","url","relativeURL","baseUrlString","sRelPath","baseLocation","createElement","nUpLn","nEnd","sDir","sPath","replace","nStart","exec","RegExp","portStr","port","protocol","substr","relPathToAbs","baseUrl","setAllDefaults","setFavicon","loadCSS","link","querySelector","type","rel","favicon","default","getElementsByTagName","appendChild","css","buttonSignIn","loginButtonGetHTML","text","fetchGetText","html","head","media","Assets","Service","serviceInfoUrl","serviceCustomizations","_serviceInfo","_polling","_serviceInfoUrl","_pryvServiceCustomizations","info","forceFetch","baseServiceInfo","setServiceInfo","supportsHF","infos","features","noHF","isDnsLess","api","includes","definitions","apiEndpointFor","username","token","buildAPIEndpoint","endpoint","login","password","appId","originHeader","apiEndpoint","headers","register","Origin","Connection","myMessages","res","keys","en","fr","LOGIN","SIGNOUT_CONFIRM","EVENTMARKERS","foreachEvent","includeDeletions","eventOrEventDeletions","buffer","depth","inString","skipNextOne","cursorPos","eventsCount","eventDeletionsCount","processEvents","charCodeAt","eventsOrDeletionMsg","ignoreComa","eventStr","addEvent","fn","setEncoding","on","chunk","n","searchStartEvents","processBuffer","err","bodyObject","err_","rawResponse","statusCode","strEvent","LoginButton","CookieUtils","setupAuth","serviceInfoFromUrl","getQueryParamsFromURL","pryvServiceInfoUrl","regexAPIandToken","regexSchemaAndPath","queryParams","queryStr","URLSearchParams","toString","myHeaders","Accept","fetch","json","data","method","extractTokenAndAPIEndpoint","lastIndex","endsWith","res2","tokenAndAPI","navigator","check","a","userAgent","vendor","opera","test","vars","m","extractTokenAndApiEndpoint","buildPryvApiEndpoint","REFUSED","AuthController","HumanInteraction","humanInteraction","jsonParser","libGetEventStreamed","PryvError","getTimestamp","now","options","chunkSize","_deltaTime","weight","_service","accessInfo","user","arrayOfAPICalls","progress","_chunkedBatchCall","batchCall","post","apiOne","params","expectedKey","innerObject","revoke","throwOnFail","usingConnection","callHandler","Array","isArray","percent","cursor","thisBatch","cursorMax","Math","min","i","resRequest","results","handleResult","prototype","apply","round","_postFetch","_handleMeta","_postFetchRaw","contentType","Authorization","_getFetchRaw","addPointsToHFEvent","eventId","fields","points","format","getEventsStreamed","forEachEvent","myParser","createEventWithFile","event","filePath","fs","fileName","basename","mimeType","getMimeType","extname","fileBlob","openAsBlob","formData","FormData","append","createEventWithFileFromBuffer","bufferData","filename","lastDot","lastIndexOf","getExtname","Blob","createEventWithFormData","deltaTime","requestLocalTimestamp","meta","serverTime","MIME_TYPES","ext","toLowerCase","conn","queryParam","parser","parserSettings","ondata","onend","encoding","fakeRes","f","errResult","bodyObjectResult","URL","search","fetchParams","reader","getReader","done","read","TextDecoder","decode","pair","entries","Cookies","authSettings","loginBtn","loginButtonSpan","getElementById","spanButtonID","loginButtonText","addEventListener","onClick","innerHTML","_cookieKey","auth","serviceName","loginUrl","authUrl","screenX","screenLeft","screenY","screenTop","outerWidth","clientWidth","outerHeight","clientHeight","floor","popup","open","focus","startLoginScreen","saveAuthorizationData","confirm","deleteAuthorizationData","getErrorMessage","authData","prYvkey","prYvpoll","retrievePollUrl","super","captureStackTrace","Auth","Browser","version","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","globalThis","Function","__webpack_exports__"],"ignoreList":[],"sourceRoot":""}